name: Build iOS (IPA from .pck)

on:
  workflow_dispatch:

env:
  GODOT_VERSION: 4.3
  IOS_PRESET: iOS
  NAME: GoodbyeEternity
  HOMEBREW_NO_AUTO_UPDATE: 1

jobs:
  build-ios:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Download Godot headless
      run: |
        curl -L \
          "https://github.com/godotengine/godot-builds/releases/download/4.3/Godot_v4.3-stable_macos.universal.zip" \
          -o godot.zip
        unzip -q godot.zip -d godot

    - name: Install export templates
      run: |
        templates_root="$HOME/Library/Application Support/Godot/export_templates"
        mkdir -p "$templates_root"
        cp -R export_templates/. "$templates_root"

    - name: Export Xcode project
      run: |
        mkdir -p build/ios
        godot/Godot.app/Contents/MacOS/Godot --headless --path . \
          --export-release "${IOS_PRESET}" build/ios/${NAME}.xcodeproj

    - name: Replace default .pck with your actual one
      run: |
        cp GoodbyeEternity.pck build/ios/${NAME}.xcodeproj/GoodbyeEternity.pck

    - name: Build unsigned .ipa
      run: |
        xcodebuild archive \
          -project build/ios/${NAME}.xcodeproj \
          -scheme "${NAME}" \
          -archivePath build/ios/App.xcarchive \
          -configuration Release \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | xcpretty

    - name: Package IPA
      run: |
        cd build/ios
        mkdir -p Payload
        cp -R App.xcarchive/Products/Applications/*.app Payload/
        zip -r "${NAME}.ipa" Payload
        mv "${NAME}.ipa" ../../

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: GoodbyeEternity-iOS
        path: GoodbyeEternity.ipa
